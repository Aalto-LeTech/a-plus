{% load i18n %}
{% load course %}
{% load exercise %}

{% if categories|length > 1 %}
<p class="filter-categories">
  <small>{% trans "Filter view" %}:</small>
  {% for entry in categories %}
  {% if entry|is_listed %}
  <button class="btn btn-default btn-xs" data-category="{{ entry.id }}">
    <span class="glyphicon glyphicon-check" aria-hidden="true"></span>
    {{ entry.name }}
  </button>
  {% endif %}
  {% endfor %}
</p>
{% endif %}

<p id="toggle-expired" class="hide"><a href="#">{% trans "Show older assignments." %}</a></p>

{% for entry in toc %}
  {% if entry|is_visible %}

  {% if entry.type == 'module' %}
    {% with open=entry|is_open:now after_open=entry|has_opened:now %}
<div class="panel panel-primary module-panel{% if not open and after_open %} module-expired{% endif %}">
  <a class="panel-heading{% if not open %} collapsed{% endif %}"
    role="button" href="#module{{ entry.id }}" data-toggle="collapse"
    aria-expanded="{% if open %}true{% else %}false{% endif %}" aria-controls="#module{{ entry.id }}">
    <h3 class="panel-title">
      {% points_badge entry "pull-right" %}
      {% if not open and not after_open %}
      <span class="badge pull-right">
        {% trans "Opens" %} {{ entry.opening_time }}
      </span>
      {% endif %}
      <span class="caret" aria-hidden="true"></span>
      {{ entry.name }}
    </h3>
  </a>
  <div class="collapse{% if open %} in{% endif %}" id="module{{ entry.id }}">
  <div class="panel-body">
    <p>
      {{ entry.opening_time }} &ndash; {{ entry.closing_time }}

      {% if entry.late_allowed %}
      <br />
      <em>
        {% blocktrans with deadline=entry.late_time %}
        Late submission are allowed until {{ deadline }}
        {% endblocktrans %}
        {% if entry.late_percent != 100 %}
        {% blocktrans with percent=entry.late_percent %}
        but points are only worth {{ percent }}%.
        {% endblocktrans %}
        {% endif %}
      </em>
      {% endif %}

      {% if entry.points_to_pass > 0 %}
      <br />
      {% blocktrans with points=entry.points_to_pass %}
      {{ points }} points required to pass the module.
      {% endblocktrans %}
      {% endif %}
    </p>

    {% points_progress entry %}
    {{ entry.introduction|safe }}
  </div>
  <table class="table table-striped table-condensed results-table">
    <tbody>
      <tr class="category-row" data-category="{{ category.id }}">
        <th>{% trans "Exercise" %}</th>
        <th>{% trans "Category" %}</th>
        <th class="col-md-2">{% trans "Points" %}</th>
        {% if is_course_staff %}
        <th>{% trans "Course staff" %}</th>
        {% endif %}
      </tr>
    {% endwith %}

  {% elif entry.type == 'exercise' %}
    {% with after_open=entry|has_opened:now %}
    {% if entry.submittable %}
      <tr data-category="{{ entry.category_id }}">
        <td>
          {% if after_open %}
            {% if entry.parent_link %}
          <a href="{{ entry.parent_link }}#chapter-exercise-{{ entry.order }}" class="{% if entry|is_in_maintenance %}maintenance{% endif %}">{{ entry.name }}</a>
            {% else %}
          <a href="{{ entry.link }}" class="{% if entry|is_in_maintenance %}maintenance{% endif %}">{{ entry.name }}</a>
            {% endif %}
          {% else %}
          {{ entry.name }}
          {% endif %}
        </td>
        <td>
          <small>{{ entry.category }}</small>
        </td>
        <td>
          {% points_badge entry %}
        </td>
        {% if is_course_staff %}
        <td>
          {% if not after_open %}
          <a class="btn btn-default btn-xs" href="{{ entry.link }}">
            <span class="glyphicon glyphicon-lock" aria-hidden="true"></span>
            {% trans "Early access" %}
          </a>
          {% endif %}
          <a class="btn btn-default btn-xs" href="{{ entry.submissions_link }}">
            <span class="glyphicon glyphicon-list" aria-hidden="true"></span>
            {% trans "View submissions" %}
          </a>
        </td>
        {% endif %}
      </tr>
    {% else %}
      <tr>
        <td colspan="4">
          <small>{{ entry.name }}</small>
        </td>
      </tr>
    {% endif %}
    {% endwith %}
  {% endif %}
  {% endif %}

  {% for level in entry.close_levels %}
  {% if level == 'm' %}
    </tbody>
  </table>
  </div>
</div>
  {% endif %}
  {% endfor %}

{% endfor %}

<script>
$(function() {
  var limit = 1;
  var expired = $(".module-expired");
  if (expired.size() > limit) {
    expired.slice(0, expired.size() - limit).hide();
    $("#toggle-expired").removeClass("hide")
    .find("a").on("click", function(event) {
      event.preventDefault();
      $(".module-expired:hidden").show();
      $(this).parent().hide();
    });
  }

  $('.filter-categories button').on("click", function(event) {
    var button = $(this);
    var id = button.attr("data-category");
    if (button.hasClass("active")) {
      button.removeClass("active")
      .find("span").removeClass("glyphicon-unchecked").addClass("glyphicon-check");
      $('.module-panel tr[data-category="' + id + '"]').removeClass("hide");
    } else {
      button.addClass("active")
      .find("span").removeClass("glyphicon-check").addClass("glyphicon-unchecked");
      $('.module-panel tr[data-category="' + id + '"]').addClass("hide");
    }
    $('.module-panel').each(function(index, panel) {
      var mod = $(panel);
      if (mod.find("tr:not(.hide)").size() > 0) {
        mod.removeClass("hide");
      } else {
        mod.addClass("hide");
      }
    });
  });
});
</script>
